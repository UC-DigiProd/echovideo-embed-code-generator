<script>
    /**
     * Re-introducing proper full escaping for <, >, &, and " to ensure the code displays as raw text.
     */
    function escapeHtml(text) {
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    /**
     * Highlights fully HTML-escaped code by selectively inserting span tags.
     */
    function highlightCode(escapedCode) {
        // Regex to capture:
        // Group 1: &lt; or &lt;/ (Opening/closing bracket start)
        // Group 2: The tag name (e.g., div, iframe)
        // Group 3: Attributes and closing bracket (&gt;)
        // Group 4: Text content (everything not inside a tag)
        const htmlRegex = /(\s*&lt;\/?)([a-zA-Z0-9]+)([^&]*&gt;)|([^&]+)/g;

        // Regex to match attributes within the attribute string
        // Group 1: Space
        // Group 2: Attribute name
        // Group 3: =
        // Group 4: &quot;
        // Group 5: Attribute value content (non-quote)
        // Group 6: &quot;
        const attributeRegex = /(\s+)([a-z0-9-]+)(=)(&quot;)([^&]*)(&quot;)/gi;
        
        let highlightedCode = escapedCode.replace(htmlRegex, (match, bracketStart, tagName, attributesAndClose, textContent) => {
            if (tagName) { // It's a tag
                // 1. Highlight attributes
                let highlightedAttributes = attributesAndClose.replace(attributeRegex, (attrMatch, space, attrName, equals, quoteOpen, attrValue, quoteClose) => {
                    // Highlight attribute name, equals, and value
                    return `${space}<span class="attribute">${attrName}</span>${equals}${quoteOpen}<span class="value">${attrValue}</span>${quoteClose}`;
                });
                
                // 2. Separate the closing bracket (&gt;)
                const closingBracket = highlightedAttributes.match(/&gt;$/) ? highlightedAttributes.slice(-4) : '';
                highlightedAttributes = highlightedAttributes.slice(0, -4); // Remove &gt; for separate highlighting

                // 3. Highlight tag name and brackets
                return `<span class="bracket">${bracketStart}</span><span class="tag">${tagName}</span>${highlightedAttributes}<span class="bracket">${closingBracket}</span>`;

            } else if (textContent) { // It's text content
                if (textContent.trim().length > 0) {
                    return `<span class="text">${textContent}</span>`;
                }
                return textContent; // Return whitespace as is
            }
            return match; // Fallback
        });
        
        // Final pass for &amp; that might be part of URLs (must be within a highlighted span)
        highlightedCode = highlightedCode.replace(/&amp;/g, '<span class="value">&amp;</span>');

        return highlightedCode;
    }

    function generateCode() {
        const title = document.getElementById('videoTitle').value.trim();
        const source = document.getElementById('source').value.trim();
        const year = document.getElementById('year').value.trim();
        const ltiCode = document.getElementById('ltiCode').value.trim();
        const outputDiv = document.getElementById('outputCode');
        const copyBtn = document.getElementById('copyButton');

        // 1. Validate Input
        if (!title || !ltiCode) {
            outputDiv.innerHTML = 'Please provide a **Video title** and the **Echo LTI iframe Code**.';
            copyBtn.style.display = 'none';
            return;
        }

        // 2. Extract the [src] attribute
        const srcRegex = /src=["'](.*?)["']/i;
        const match = ltiCode.match(srcRegex);
        
        if (!match || match.length < 2) {
            outputDiv.innerHTML = 'Error: Could not extract a valid `src` attribute from the provided LTI code.';
            copyBtn.style.display = 'none';
            return;
        }

        const srcValue = match[1];

        // 3. Construct the Final HTML
        const rawGeneratedHtml =
`<div style="display: flex; justify-content: center; align-items: center; max-width: 704px; min-width: 320px; margin: auto;">
    <div style="position: relative; width: 100%; padding-bottom: 65.625%; height: 0;"><iframe class="lti-embed" style="border: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;" title="Echo video: ${title}" role="region" src="${srcValue}" name="Echo Video Player iframe" loading="lazy" allowfullscreen="allowfullscreen" webkitallowfullscreen="webkitallowfullscreen" mozallowfullscreen="mozallowfullscreen" allow="geolocation *; microphone *; camera *; midi *; encrypted-media *; autoplay *; clipboard-write *; display-capture *" aria-label="Echo video player"></iframe></div>
</div>
<p style="text-align: center;">Source: <a href="${srcValue}" target="_blank" rel="noopener">${title}</a> (${source}, ${year})</p>`;

        // 4. Highlight the code for display
        // FIRST: Full HTML Escape
        const escapedHtml = escapeHtml(rawGeneratedHtml);
        // SECOND: Apply highlighting spans
        const highlightedHtml = highlightCode(escapedHtml);

        // 5. Display the Highlighted Code
        outputDiv.innerHTML = highlightedHtml; // Use innerHTML to render the span tags
        copyBtn.style.display = 'block'; 
        
        // Store the *unhighlighted* code for copying
        outputDiv.dataset.rawCode = rawGeneratedHtml;
    }
    
    function copyCode() {
        const outputDiv = document.getElementById('outputCode');
        // Use the raw code stored in the dataset for copying
        const code = outputDiv.dataset.rawCode;
        const copyBtn = document.getElementById('copyButton');
        
        if (!code || code.includes('Please provide') || code.includes('Error: Could not extract')) {
             alert('No valid code generated yet to copy.');
             return;
        }

        navigator.clipboard.writeText(code).then(() => {
            copyBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.textContent = 'Copy code to clipboard';
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            alert('Failed to copy the code. Please try selecting the text manually.');
        });
    }

    function resetGenerator() {
        document.getElementById('videoTitle').value = '';
        document.getElementById('source').value = 'UC';
        document.getElementById('year').value = '2026';
        document.getElementById('ltiCode').value = '';
        
        const outputDiv = document.getElementById('outputCode');
        outputDiv.innerHTML = ''; // Use innerHTML for reset
        outputDiv.removeAttribute('data-raw-code'); // Clear raw code
        document.getElementById('copyButton').style.display = 'none';
        
    }
</script>
